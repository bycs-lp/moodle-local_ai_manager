{"version":3,"file":"userquota.min.js","sources":["../src/userquota.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module handling the form submission of the statistics tables of local_ai_manager.\n *\n * @module     local_ai_manager/userquota\n * @copyright  2024 ISB Bayern\n * @author     Philipp Memmel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call as fetchMany} from 'core/ajax';\nimport {getStrings} from 'core/str';\nimport Templates from 'core/templates';\n\nconst constants = {\n    MAXUSAGE_UNLIMITED: 999999\n};\n\nconst queryCountStrings = {\n    chat: 'chat requests',\n    feedback: 'feedback requests',\n    imggen: 'image generation generation requests',\n    singleprompt: 'text requests',\n    translate: 'translation requests',\n    tts: 'audio requests'\n};\n\nconst fetchUserquotaData = () => fetchMany([{\n    methodname: 'local_ai_manager_get_user_quota',\n    args: {},\n}])[0];\n\n/**\n * Renders the current user usage information into the element identified by the given selector.\n *\n * @param {string} selector the id of the element to insert the infobox\n * @param {string[]} purposes the purposes to show user quota for\n */\nexport const renderUserQuota = async (selector, purposes) => {\n    await localizeQueryCountTexts();\n\n    const targetElement = document.querySelector(selector);\n    const userquotaData = await fetchUserquotaData();\n    const purposeInfo = [];\n\n    purposes.forEach(purpose => {\n        purposeInfo.push(\n            {\n                purpose,\n                'currentusage': userquotaData.usage[purpose].currentusage,\n                maxusage: userquotaData.usage[purpose].maxusage,\n                'querycounttext': queryCountStrings[purpose],\n                showmaxusage: userquotaData.usage[purpose].maxusage !== constants.MAXUSAGE_UNLIMITED,\n                islastelement: false\n            });\n    });\n    purposeInfo[purposeInfo.length - 1].islastelement = true;\n\n    const userquotaContentTemplateContext = {\n        purposes: purposeInfo,\n        period: userquotaData.period,\n        unlimited: userquotaData.role === 'role_unlimited'\n    };\n    const {html, js} = await Templates.renderForPromise('local_ai_manager/userquota', userquotaContentTemplateContext);\n    Templates.appendNodeContents(targetElement, html, js);\n};\n\nconst localizeQueryCountTexts = async () => {\n    const stringsToFetch = [];\n    Object.keys(queryCountStrings).forEach((key) => {\n        stringsToFetch.push({key: 'requestcount', component: 'aipurpose_' + key});\n    });\n    const strings = await getStrings(stringsToFetch);\n    let i = 0;\n    for (const key in queryCountStrings) {\n        queryCountStrings[key] = strings[i];\n        i++;\n    }\n};\n"],"names":["constants","queryCountStrings","chat","feedback","imggen","singleprompt","translate","tts","async","selector","purposes","localizeQueryCountTexts","targetElement","document","querySelector","userquotaData","methodname","args","purposeInfo","forEach","purpose","push","usage","currentusage","maxusage","showmaxusage","islastelement","length","userquotaContentTemplateContext","period","unlimited","role","html","js","Templates","renderForPromise","appendNodeContents","stringsToFetch","Object","keys","key","component","strings","i"],"mappings":";;;;;;;;iKA4BMA,6BACkB,OAGlBC,kBAAoB,CACtBC,KAAM,gBACNC,SAAU,oBACVC,OAAQ,uCACRC,aAAc,gBACdC,UAAW,uBACXC,IAAK,2CAcsBC,MAAOC,SAAUC,kBACtCC,gCAEAC,cAAgBC,SAASC,cAAcL,UACvCM,oBAfuB,cAAU,CAAC,CACxCC,WAAY,kCACZC,KAAM,MACN,GAaMC,YAAc,GAEpBR,SAASS,SAAQC,UACbF,YAAYG,KACR,CACID,QAAAA,qBACgBL,cAAcO,MAAMF,SAASG,aAC7CC,SAAUT,cAAcO,MAAMF,SAASI,wBACrBvB,kBAAkBmB,SACpCK,aAAcV,cAAcO,MAAMF,SAASI,WAAaxB,6BACxD0B,eAAe,OAG3BR,YAAYA,YAAYS,OAAS,GAAGD,eAAgB,QAE9CE,gCAAkC,CACpClB,SAAUQ,YACVW,OAAQd,cAAcc,OACtBC,UAAkC,mBAAvBf,cAAcgB,OAEvBC,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,6BAA8BP,oDACxEQ,mBAAmBxB,cAAeoB,KAAMC,WAGhDtB,wBAA0BH,gBACtB6B,eAAiB,GACvBC,OAAOC,KAAKtC,mBAAmBkB,SAASqB,MACpCH,eAAehB,KAAK,CAACmB,IAAK,eAAgBC,UAAW,aAAeD,eAElEE,cAAgB,mBAAWL,oBAC7BM,EAAI,MACH,MAAMH,OAAOvC,kBACdA,kBAAkBuC,KAAOE,QAAQC,GACjCA"}